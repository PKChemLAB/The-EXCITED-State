<div id="tcomment"></div>
<script>
    // 1. 自动检测当前主题颜色
    function getTheme() {
        return document.body.className.includes("dark") ? "dark" : "light";
    }

    // 2. 加载 Giscus
    let theme = getTheme();
    let s = document.createElement('script');
    s.src = 'https://giscus.app/client.js';
    s.setAttribute('data-repo', '{{ .Site.Params.giscus.repo }}');
    s.setAttribute('data-repo-id', '{{ .Site.Params.giscus.repoId }}');
    s.setAttribute('data-category', '{{ .Site.Params.giscus.category }}');
    s.setAttribute('data-category-id', '{{ .Site.Params.giscus.categoryId }}');
    s.setAttribute('data-mapping', 'pathname');
    s.setAttribute('data-reactions-enabled', '1');
    s.setAttribute('data-emit-metadata', '0');
    s.setAttribute('data-input-position', 'bottom');
    s.setAttribute('data-theme', theme);
    s.setAttribute('data-lang', 'zh-CN');
    s.setAttribute('crossorigin', 'anonymous');
    s.setAttribute('async', '');
    document.querySelector('#tcomment').appendChild(s);

    // 3. 监听主题切换按钮，实时切换评论区颜色
    const themeToggle = document.querySelector('#theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            let newTheme = document.body.className.includes("dark") ? "light" : "dark"; // 注意这里逻辑反一下，因为点击时class还没变
            // 实际上为了准确，稍微延时或重新获取
            setTimeout(() => {
                let finalTheme = getTheme();
                const iframe = document.querySelector('iframe.giscus-frame');
                if (!iframe) return;
                iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: finalTheme } } }, 'https://giscus.app');
            }, 100);
        });
    }
</script>